# Changelog

Все важные изменения в проекте micro-file-cache документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект следует [Semantic Versioning](https://semver.org/lang/ru/).

## [1.0.1] - 2024-12-19

### Fixed

- **Исправлена логика валидации MIME типов**
  - По умолчанию теперь разрешены любые MIME типы (пустой массив `ALLOWED_MIME_TYPES`)
  - Ограничения применяются только при явном указании типов в переменной окружения
  - Обновлена функция `parseAllowedMimeTypes()` в `app.config.ts`
  - Исправлена валидация в `ValidationUtil.validateUploadedFile()`
  - Обновлены тесты для корректной проверки новой логики

### Changed

- **Обновлена документация**
  - Добавлено подробное описание логики MIME типов в `development-guide.md`
  - Обновлены примеры конфигурации в `ENV_SETUP.md`
  - Уточнено описание переменной `ALLOWED_MIME_TYPES` в документации

## [1.0.0] - 2024-12-19

### Added

- **Полная реализация микросервиса micro-file-cache** (Этапы 4-17)
- Реализация утилит для работы с файлами (Этап 4)
  - HashUtil для SHA-256 хеширования файлов
  - FilenameUtil для безопасной работы с именами файлов
  - ValidationUtil для валидации входных данных
- Реализация StorageModule (Этап 5)
  - StorageService для работы с файловой системой
  - Безопасное определение MIME типов через file-type
  - Работа с метаданными в data.json
  - Организация файлов по датам (YYYY-MM)
- Интеграция StorageModule в AppModule (Этап 6)
  - Тестовый endpoint для проверки StorageService
- Создание DTO и валидации (Этап 7)
  - UploadFileDto для загрузки файлов
  - FileResponseDto для ответов API
  - HealthResponseDto для health check
  - Валидация с class-validator
- Реализация FilesService (Этап 8)
  - Загрузка файлов с дедупликацией
  - Получение информации о файлах
  - Удаление файлов
  - Валидация TTL и размера файлов
- Реализация FilesController (Этап 9)
  - POST /api/v1/files для загрузки
  - GET /api/v1/files/:id для получения информации
  - GET /api/v1/files/:id/download для скачивания
  - DELETE /api/v1/files/:id для удаления
  - GET /api/v1/health для проверки состояния
- Создание FilesModule и интеграция (Этап 10)
  - Настройка Multer для загрузки файлов
  - Глобальные пайпы валидации
  - Интеграция в AppModule
- Реализация CleanupModule (Этап 11)
  - CleanupService для удаления устаревших файлов
  - Cron job для периодического запуска
  - Логирование операций очистки
- Интеграция CleanupModule в AppModule (Этап 12)
  - Автоматическая очистка по расписанию
- Написание unit тестов (Этап 14)
  - Тесты для StorageService
  - Тесты для FilesService
  - Тесты для CleanupService
  - Тесты для утилит
  - Покрытие кода не менее 80%
- Написание E2E тестов (Этап 15)
  - Интеграционные тесты для всех API endpoints
  - Тестирование аутентификации
  - Тестирование валидации входных данных
  - Тестирование обработки ошибок
- Финальная настройка и документация (Этап 17)
  - Обновление README.md с полными инструкциями
  - Обновление CHANGELOG.md
  - Проверка всех переменных окружения
  - Создание примеров использования

### Changed

- Обновлена структура проекта для полной функциональности
- Улучшена документация с примерами использования
- Оптимизированы настройки для продакшена

### Technical Details

- Микросервис полностью функционален и готов к использованию
- Все API endpoints работают корректно
- Аутентификация функционирует
- Автоматическая очистка работает по расписанию
- Docker контейнер запускается без ошибок
- Документация актуальна и полная
- Все тесты проходят успешно
- Покрытие кода составляет более 80%

## [0.1.0] - 2024-12-19

### Added

- Docker конфигурация (Этап 16)
- Dockerfile для продакшн сборки с многоэтапной сборкой
- Dockerfile.dev для режима разработки с hot reload
- docker-compose.yml для оркестрации контейнеров
- .dockerignore для исключения ненужных файлов из Docker контекста
- env.docker с переменными окружения для Docker
- Health check в Docker контейнере
- DOCKER_USAGE.md с инструкциями по использованию Docker
- DOCKER_README.md с подробной документацией по Docker
- Поддержка продакшн и dev режимов в Docker
- Volumes для постоянного хранения данных
- Сетевая конфигурация для изоляции контейнеров
- Безопасность: запуск под непривилегированным пользователем
- Alpine Linux для минимального размера образа
- Автоматическая очистка кэша pnpm для уменьшения размера образа

- Настройка базовой структуры проекта (Этап 1)
- Создание структуры папок согласно архитектуре
- Настройка TypeScript конфигурации (tsconfig.json, tsconfig.build.json)
- Настройка ESLint и Prettier для линтинга и форматирования кода
- Настройка nest-cli.json для NestJS CLI
- Создание конфигурации для E2E тестов (test/jest-e2e.json)
- Базовая структура AppModule с ConfigModule
- Установка всех необходимых зависимостей
- Поддержка переменных окружения LISTEN_HOST и LISTEN_PORT для настройки хоста и порта
- Создание интерфейсов и типов данных (Этап 2)
- Интерфейсы для файлов и метаданных (file.interface.ts)
- Интерфейсы для работы с хранилищем (storage.interface.ts)
- Интерфейсы для API ответов и запросов (api.interface.ts)
- Конфигурация приложения с валидацией (app.config.ts)
- Создание базового AppModule и main.ts (Этап 3)
- Обновление AppModule с правильной конфигурацией
- Настройка Fastify адаптера в main.ts
- Создание HealthController с health endpoint
- Глобальные фильтры исключений и пайпы валидации
- Интеграция Swagger документации
- Реализация аутентификации (Этап 13)
- AuthGuard для проверки Bearer токенов
- Декоратор @Auth() для применения аутентификации к контроллерам и методам
- Декоратор @Public() для исключения методов из аутентификации
- Глобальная аутентификация через APP_GUARD
- Исключение /api/v1/health из аутентификации
- Поддержка переменных окружения AUTH_ENABLED и AUTH_TOKEN (в production режиме минимум 32 символа)
- Создание файла конфигурации env.dev для разработки
- Документация по настройке переменных окружения (docs/ENV_SETUP.md)
- Руководство по быстрому старту (docs/QUICK_START.md)

### Changed

- Обновлен main.ts для использования LISTEN_HOST (по умолчанию localhost) и LISTEN_PORT (по умолчанию 3000)
- Обновлен env.example с новыми переменными окружения
- Обновлена документация (README.md, architecture.md) с информацией о новых переменных

### Technical Details

- Проект успешно компилируется без ошибок TypeScript
- Линтинг проходит без ошибок
- Создана полная структура папок для всех модулей
- Настроены пути для импортов (@/_, @/common/_, @/modules/\*)
- Микросервис теперь слушает на настраиваемом хосте и порту через переменные окружения
- Созданы типизированные интерфейсы для всех компонентов системы
- Реализована валидация конфигурации с детальными сообщениями об ошибках
- Все интерфейсы корректно экспортируются и могут быть импортированы
- Приложение успешно запускается и отвечает на health check по адресу /api/v1/health
- Health endpoint возвращает детальную информацию о состоянии системы
- Настроены глобальные фильтры для обработки ошибок и валидации
- Интегрирована Swagger документация для API
- Аутентификация работает корректно: защищенные endpoints требуют валидный Bearer токен
- Health endpoint исключен из аутентификации и доступен без токена
- Невалидные токены отклоняются с ошибкой 401 Unauthorized
- Валидные токены позволяют доступ ко всем защищенным API endpoints
- Аутентификация настраивается через переменные окружения AUTH_ENABLED и AUTH_TOKEN (в production режиме минимум 32 символа)
