# E2E Тесты для micro-file-cache

Каталог `test/e2e/` содержит End-to-End (E2E) тесты для микросервиса file-cache. E2E тесты проверяют полную функциональность приложения от HTTP запросов до файловой системы.

## Структура тестов

### Основные файлы тестов

- **`test/e2e/app.e2e-spec.ts`** - Основные E2E тесты приложения
  - Тестирует базовую функциональность
  - Проверяет health endpoint
  - Проверяет основные операции с файлами

- **`test/e2e/auth.e2e-spec.ts`** - Специализированные тесты аутентификации
  - Тестирует различные сценарии аутентификации
  - Проверяет валидацию токенов
  - Тестирует обработку ошибок авторизации
  - Проверяет edge cases с токенами

- **`test/e2e/files.controller.e2e-spec.ts`** - Детальные тесты FilesController
  - Тестирует все endpoints контроллера файлов
  - Проверяет загрузку, получение информации, скачивание и удаление
  - Тестирует валидацию и обработку ошибок
  - Проверяет фильтрацию и пагинацию

- **`test/e2e/integration.e2e-spec.ts`** - Интеграционные тесты
  - Тестирует сложные сценарии использования
  - Проверяет полный жизненный цикл файлов
  - Тестирует дедупликацию файлов
  - Проверяет массовые операции

- **`test/e2e/performance.e2e-spec.ts`** - Тесты производительности
  - Тестирует производительность при различных нагрузках
  - Проверяет время выполнения операций
  - Тестирует использование памяти
  - Проверяет concurrent операции

### Утилиты

- **`test/e2e/e2e-test-utils.ts`** - Утилиты для E2E тестов
  - Функции для создания тестового приложения
  - Вспомогательные методы для создания тестовых файлов
  - Утилиты для измерения производительности
  - Общие функции проверки

### Конфигурация тестов

E2E тесты используют файл `env.test` со следующими особенностями:

- **Аутентификация**: Включена с простым тестовым ключом `test-secret-key`
- **Логирование**: Минимальное (уровень `error`) для чистого вывода тестов
- **Очистка**: Отключена для стабильности тестов
- **MIME типы**: Расширенный список для тестирования различных типов файлов
- **Размеры файлов**: Ограничения оптимизированы для тестов (50MB)
- **Порт**: Автоматический выбор порта (0) для избежания конфликтов

## Запуск тестов

### Предварительные требования

1. Убедитесь, что все зависимости установлены:

   ```bash
   pnpm install
   ```

2. E2E тесты используют специальный файл конфигурации `env.test`:

   ```bash
   # Файл env.test уже настроен для тестов
   # Он содержит оптимизированные настройки для тестирования
   ```

3. Убедитесь, что приложение компилируется:
   ```bash
   pnpm run build
   ```

### Запуск всех E2E тестов

```bash
pnpm run test:e2e
```

### Запуск конкретных тестов

```bash
# Основные тесты приложения
pnpm run test:e2e -- --testNamePattern="AppController"

# Тесты контроллера файлов
pnpm run test:e2e -- --testNamePattern="FilesController"

# Интеграционные тесты
pnpm run test:e2e -- --testNamePattern="Integration Tests"

# Тесты производительности
pnpm run test:e2e -- --testNamePattern="Performance Tests"
```

### Запуск с дополнительными опциями

```bash
# Запуск с подробным выводом
pnpm run test:e2e -- --verbose

# Запуск в watch режиме
pnpm run test:e2e -- --watch

# Запуск с покрытием кода
pnpm run test:e2e -- --coverage

# Запуск с таймаутом
pnpm run test:e2e -- --testTimeout=60000
```

## Конфигурация тестов

### Переменные окружения

Тесты используют следующие переменные окружения:

- `AUTH_ENABLED=true` - Включение аутентификации
- `AUTH_TOKEN` - Секретный ключ для аутентификации (в production режиме минимум 32 символа)
- `STORAGE_DIR` - Путь к хранилищу файлов

### Настройка Jest

Конфигурация Jest для E2E тестов находится в `jest-e2e.json`:

```json
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  },
  "collectCoverageFrom": ["**/*.(t|j)s"],
  "coverageDirectory": "../coverage",
  "testTimeout": 30000
}
```

## Структура тестов

### Базовые тесты (test/e2e/app.e2e-spec.ts)

- **Health Check** - Проверка состояния приложения
- **Authentication** - Тестирование аутентификации
- **File Operations** - Основные операции с файлами
- **Error Handling** - Обработка ошибок
- **File Validation** - Валидация файлов
- **Pagination and Filtering** - Пагинация и фильтрация

### Детальные тесты (test/e2e/files.controller.e2e-spec.ts)

- **POST /api/v1/files** - Загрузка файлов
- **GET /api/v1/files/:id** - Получение информации о файле
- **GET /api/v1/files/:id/download** - Скачивание файлов
- **DELETE /api/v1/files/:id** - Удаление файлов
- **GET /api/v1/files** - Список файлов
- **GET /api/v1/files/stats** - Статистика файлов
- **GET /api/v1/files/:id/exists** - Проверка существования файла

### Интеграционные тесты (test/e2e/integration.e2e-spec.ts)

- **File Lifecycle Management** - Полный жизненный цикл файлов
- **Bulk Operations** - Массовые операции
- **Error Recovery and Resilience** - Восстановление после ошибок
- **File Type and Content Handling** - Обработка различных типов файлов

### Тесты производительности (test/e2e/performance.e2e-spec.ts)

- **Upload Performance** - Производительность загрузки
- **Download Performance** - Производительность скачивания
- **List and Query Performance** - Производительность списков и запросов
- **Memory Usage** - Использование памяти
- **Concurrent Operations** - Concurrent операции
- **Stress Testing** - Стресс-тестирование

## Временные файлы

Тесты создают временные директории для хранения тестовых файлов в корне репозитория:

- `test-data/micro-file-cache/temp-storage` - для основных тестов
- `test-data/micro-file-cache/temp-storage-files` - для тестов контроллера файлов
- `test-data/micro-file-cache/temp-storage-integration` - для интеграционных тестов
- `test-data/micro-file-cache/temp-storage-performance` - для тестов производительности
- `test-data/micro-file-cache/temp-storage-auth` - для тестов аутентификации
- `test-data/micro-file-cache/temp-storage-simple` - для простых тестов

Эти директории автоматически очищаются после завершения тестов.

### Основное хранилище

Основное хранилище файлов для разработки и тестирования находится в:

- `test-data/micro-file-cache/storage/` - основное хранилище файлов

## Отладка тестов

### Включение подробного логирования

```bash
# Запуск с подробным выводом
pnpm run test:e2e -- --verbose

# Запуск одного теста
pnpm run test:e2e -- --testNamePattern="should upload a file successfully"
```

### Проверка временных файлов

Если тесты завершились с ошибкой, временные файлы могут остаться. Их можно найти в директории `test/` и удалить вручную.

### Проверка логов

Тесты используют встроенное логирование NestJS. Для отладки можно временно изменить уровень логирования в конфигурации.

## Требования к производительности

Тесты производительности проверяют следующие требования:

- Загрузка файла: < 2 секунд
- Загрузка большого файла (10MB): < 30 секунд
- Concurrent загрузки (20 файлов): < 10 секунд
- Скачивание файла: < 1 секунды
- Скачивание большого файла (5MB): < 5 секунд
- Список файлов (100 файлов): < 2 секунд
- Статистика файлов: < 1 секунды

## Известные ограничения

1. **Размер файлов**: Тесты используют файлы до 20MB для проверки производительности
2. **Количество файлов**: Тесты загружают до 200 файлов для стресс-тестирования
3. **Время выполнения**: Некоторые тесты могут занимать до 30 секунд
4. **Память**: Тесты проверяют использование памяти, но не ограничивают его

## Добавление новых тестов

При добавлении новых E2E тестов следуйте следующим рекомендациям:

1. Используйте утилиты из `e2e-test-utils.ts`
2. Очищайте временные файлы в `afterEach` и `afterAll`
3. Группируйте связанные тесты в `describe` блоки
4. Используйте описательные названия тестов
5. Проверяйте как успешные, так и ошибочные сценарии
6. Добавляйте проверки производительности для критических операций

## Troubleshooting

### Тесты не запускаются

1. Проверьте, что все зависимости установлены
2. Убедитесь, что приложение компилируется
3. Проверьте права доступа к временным директориям

### Тесты падают с ошибками аутентификации

1. Проверьте, что `AUTH_TOKEN` установлен
2. Убедитесь, что токен в тестах соответствует секретному ключу

### Тесты падают с ошибками файловой системы

1. Проверьте права доступа к директории хранилища
2. Убедитесь, что достаточно места на диске
3. Проверьте, что временные директории могут быть созданы

### Медленное выполнение тестов

1. Проверьте производительность диска
2. Убедитесь, что нет других процессов, использующих ресурсы
3. Рассмотрите возможность увеличения таймаутов для медленных систем
