# План разработки micro-file-cache

## Обзор проекта

Микросервис для временного кэширования файлов с автоматической очисткой по истечении времени жизни (TTL). Использует NestJS, TypeScript, Fastify и включает дедупликацию файлов на основе SHA-256 хеширования.

## Технический стек

- **Node.js 22 LTS** - среда выполнения
- **TypeScript** - язык программирования  
- **NestJS** - фреймворк для создания масштабируемых серверных приложений
- **Fastify** - HTTP адаптер (высокая производительность)
- **Jest** - фреймворк для тестирования
- **fs-extra** - расширенная работа с файловой системой
- **file-type** - безопасное определение MIME типа файлов
- **dayjs** - удобная работа с датами и временем
- **supertest** - E2E тестирование API endpoints
- **multer** - загрузка файлов
- **@nestjs/schedule** - автоматическая очистка по расписанию

## Этапы разработки

### Этап 1: Настройка проекта и базовая структура

**Цель**: Создать базовую структуру проекта с необходимыми конфигурационными файлами.

**Задачи**:
1. Создать структуру папок согласно архитектуре
2. Настроить TypeScript конфигурацию
3. Создать базовые конфигурационные файлы
4. Настроить ESLint и Prettier

**Файлы для создания**:
- `tsconfig.json`
- `tsconfig.build.json`
- `.eslintrc.js`
- `.prettierrc`
- `nest-cli.json`
- `test/jest-e2e.json`

**Проверка**: Проект должен компилироваться без ошибок TypeScript.

---

### Этап 2: Создание интерфейсов и типов

**Цель**: Определить все интерфейсы и типы данных для системы.

**Задачи**:
1. Создать интерфейсы для файлов и метаданных
2. Определить типы для ответов API
3. Создать интерфейсы для конфигурации

**Файлы для создания**:
- `src/common/interfaces/file.interface.ts`
- `src/common/interfaces/storage.interface.ts`
- `src/common/interfaces/api.interface.ts`
- `src/config/app.config.ts`

**Проверка**: Все интерфейсы должны быть корректно типизированы и экспортированы.

---

### Этап 3: Создание базового AppModule и main.ts

**Цель**: Создать минимальную рабочую структуру приложения для тестирования.

**Задачи**:
1. Создать базовый AppModule с минимальной конфигурацией
2. Настроить Fastify адаптер
3. Создать main.ts с правильной конфигурацией
4. Добавить базовый health endpoint
5. Настроить глобальные фильтры и пайпы

**Файлы для создания**:
- `src/app.module.ts`
- `src/main.ts`

**Проверка**: Приложение должно запускаться и отвечать на health check по адресу `/api/v1/health`.

---

### Этап 4: Создание утилит

**Цель**: Реализовать вспомогательные утилиты для работы с файлами и хешированием.

**Задачи**:
1. Создать утилиту для хеширования файлов
2. Создать утилиту для работы с именами файлов
3. Создать утилиту для валидации

**Файлы для создания**:
- `src/common/utils/hash.util.ts`
- `src/common/utils/filename.util.ts`
- `src/common/utils/validation.util.ts`

**Проверка**: Утилиты должны иметь unit тесты и корректно обрабатывать крайние случаи.

---

### Этап 5: Реализация StorageModule

**Цель**: Создать модуль для работы с файловой системой и метаданными.

**Задачи**:
1. Создать StorageService для работы с файлами
2. Реализовать методы сохранения, чтения и удаления файлов
3. Реализовать работу с data.json для метаданных
4. Добавить безопасное определение MIME типов

**Файлы для создания**:
- `src/modules/storage/storage.module.ts`
- `src/modules/storage/storage.service.ts`

**Проверка**: StorageService должен корректно сохранять и читать файлы, работать с метаданными.

---

### Этап 6: Интеграция StorageModule в AppModule

**Цель**: Интегрировать StorageModule в основное приложение и протестировать работоспособность.

**Задачи**:
1. Добавить StorageModule в AppModule
2. Создать тестовый endpoint для проверки StorageService
3. Протестировать работу с файлами через API

**Файлы для обновления**:
- `src/app.module.ts`

**Проверка**: Приложение должно запускаться с StorageModule, тестовый endpoint должен работать.

---

### Этап 7: Создание DTO и валидации

**Цель**: Создать DTO классы для валидации входных данных API.

**Задачи**:
1. Создать DTO для загрузки файлов
2. Создать DTO для ответов API
3. Настроить валидацию с class-validator

**Файлы для создания**:
- `src/modules/files/dto/upload-file.dto.ts`
- `src/modules/files/dto/file-response.dto.ts`
- `src/modules/files/dto/health-response.dto.ts`

**Проверка**: DTO должны корректно валидировать входные данные и возвращать понятные ошибки.

---

### Этап 8: Реализация FilesService

**Цель**: Создать бизнес-логику для работы с файлами.

**Задачи**:
1. Реализовать загрузку файлов с дедупликацией
2. Реализовать получение информации о файлах
3. Реализовать удаление файлов
4. Добавить валидацию TTL и размера файлов

**Файлы для создания**:
- `src/modules/files/files.service.ts`

**Проверка**: FilesService должен корректно обрабатывать все операции с файлами, включая дедупликацию.

---

### Этап 9: Реализация FilesController

**Цель**: Создать HTTP контроллер для API endpoints.

**Задачи**:
1. Реализовать POST /api/v1/files для загрузки
2. Реализовать GET /api/v1/files/:id для получения информации
3. Реализовать GET /api/v1/files/:id/download для скачивания
4. Реализовать DELETE /api/v1/files/:id для удаления
5. Реализовать GET /api/v1/health для проверки состояния

**Файлы для создания**:
- `src/modules/files/files.controller.ts`

**Проверка**: Все endpoints должны корректно обрабатывать запросы и возвращать правильные HTTP статусы.

---

### Этап 10: Создание FilesModule и интеграция

**Цель**: Объединить все компоненты модуля файлов.

**Задачи**:
1. Создать FilesModule с правильными импортами
2. Настроить Multer для загрузки файлов
3. Добавить глобальные пайпы валидации
4. Интегрировать FilesModule в AppModule
5. Протестировать все API endpoints

**Файлы для создания**:
- `src/modules/files/files.module.ts`

**Файлы для обновления**:
- `src/app.module.ts`

**Проверка**: Модуль должен корректно импортироваться, все API endpoints должны работать.

---

### Этап 11: Реализация CleanupModule

**Цель**: Создать модуль для автоматической очистки устаревших файлов.

**Задачи**:
1. Создать CleanupService для удаления устаревших файлов
2. Настроить cron job для периодического запуска
3. Реализовать логирование операций очистки

**Файлы для создания**:
- `src/modules/cleanup/cleanup.module.ts`
- `src/modules/cleanup/cleanup.service.ts`

**Проверка**: CleanupService должен корректно находить и удалять устаревшие файлы по расписанию.

---

### Этап 12: Интеграция CleanupModule в AppModule

**Цель**: Интегрировать CleanupModule в основное приложение и протестировать автоматическую очистку.

**Задачи**:
1. Добавить CleanupModule в AppModule
2. Протестировать работу cron job
3. Проверить логирование операций очистки

**Файлы для обновления**:
- `src/app.module.ts`

**Проверка**: Приложение должно запускаться с CleanupModule, автоматическая очистка должна работать по расписанию.

---

### Этап 13: Реализация аутентификации

**Цель**: Добавить Bearer токен аутентификацию для защиты API.

**Задачи**:
1. Создать AuthGuard для проверки токенов
2. Применить аутентификацию ко всем защищенным endpoints
3. Исключить /api/v1/health из аутентификации

**Файлы для создания**:
- `src/common/guards/auth.guard.ts`
- `src/common/decorators/auth.decorator.ts`

**Проверка**: Все защищенные endpoints должны требовать валидный токен, health check должен быть доступен без токена.

---

### Этап 14: Написание unit тестов

**Цель**: Создать unit тесты для всех сервисов и утилит.

**Задачи**:
1. Написать тесты для StorageService
2. Написать тесты для FilesService
3. Написать тесты для CleanupService
4. Написать тесты для утилит

**Файлы для создания**:
- `test/unit/storage.service.spec.ts`
- `test/unit/files.service.spec.ts`
- `test/unit/cleanup.service.spec.ts`
- `test/unit/hash.util.spec.ts`
- `test/unit/filename.util.spec.ts`

**Проверка**: Все unit тесты должны проходить с покрытием кода не менее 80%.

---

### Этап 15: Написание E2E тестов

**Цель**: Создать интеграционные тесты для API endpoints.

**Задачи**:
1. Написать E2E тесты для всех API endpoints
2. Протестировать аутентификацию
3. Протестировать валидацию входных данных
4. Протестировать обработку ошибок

**Файлы для создания**:
- `test/files.controller.e2e-spec.ts`
- `test/app.e2e-spec.ts`

**Проверка**: Все E2E тесты должны проходить, API должен корректно обрабатывать все сценарии.

---

### Этап 16: Создание Docker конфигурации

**Цель**: Создать Dockerfile и docker-compose.yml для развертывания.

**Задачи**:
1. Создать Dockerfile для продакшн сборки
2. Создать docker-compose.yml для разработки
3. Настроить переменные окружения
4. Добавить health check в Docker

**Файлы для создания**:
- `Dockerfile`
- `docker-compose.yml`
- `.dockerignore`

**Пример Dockerfile**:
```dockerfile
FROM node:22-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY dist/ ./dist/

EXPOSE 3000

CMD ["node", "dist/main.js"]
```

**Проверка**: Приложение должно корректно запускаться в Docker контейнере.

---

### Этап 17: Финальная настройка и документация

**Цель**: Завершить проект и обновить документацию.

**Задачи**:
1. Обновить README.md с инструкциями по запуску
2. Обновить CHANGELOG.md с описанием изменений
3. Проверить все переменные окружения
4. Создать примеры использования

**Файлы для обновления**:
- `README.md`
- `docs/CHANGELOG.md`
- `env.example`

**Проверка**: Документация должна быть актуальной и полной, проект должен быть готов к использованию.

---

## Рекомендации по работе с AI в Cursor

### Для каждого этапа:

1. **Начинайте с четкого запроса**: "Создай [конкретный файл] для [конкретной цели]"
2. **Указывайте контекст**: "В рамках NestJS проекта с TypeScript"
3. **Просите объяснения**: "Объясни как работает [конкретная функция]"
4. **Проверяйте результат**: Запускайте тесты и проверяйте компиляцию

### Примеры запросов к AI:

```
"Создай StorageService для работы с файловой системой в NestJS проекте. Сервис должен сохранять файлы в директории по дате (YYYY-MM), использовать fs-extra для работы с файлами, и поддерживать безопасное определение MIME типов через file-type."

"Напиши FilesController с методами для загрузки, получения информации, скачивания и удаления файлов. Используй Multer для загрузки, добавь валидацию через class-validator, и реализуй Bearer токен аутентификацию."

"Создай CleanupService с cron job для удаления устаревших файлов каждую минуту. Используй dayjs для работы с датами и @nestjs/schedule для cron jobs."

"Напиши unit тесты для StorageService используя Jest. Покрой все методы сервиса, включая обработку ошибок и крайние случаи."

"Создай E2E тесты для FilesController используя supertest. Протестируй все API endpoints, включая аутентификацию и валидацию."
```

### Проверка каждого этапа:

1. **Компиляция**: `pnpm run build`
2. **Линтинг**: `pnpm run lint`
3. **Тесты**: `pnpm run test`
4. **E2E тесты**: `pnpm run test:e2e`
5. **Запуск**: `pnpm run start:dev`
6. **Health Check**: `curl http://localhost:3000/api/v1/health` (после этапа 3)

### Особенности новой структуры:

- **После этапа 3**: Приложение должно запускаться и отвечать на health check
- **После этапа 6**: Можно тестировать StorageService через тестовый endpoint
- **После этапа 10**: Все API endpoints должны работать
- **После этапа 12**: Автоматическая очистка должна работать по расписанию

## Критерии готовности

Проект считается готовым когда:

- ✅ Все этапы выполнены
- ✅ Все тесты проходят
- ✅ Приложение запускается без ошибок
- ✅ API endpoints работают корректно
- ✅ Аутентификация функционирует
- ✅ Автоматическая очистка работает
- ✅ Docker контейнер запускается
- ✅ Документация актуальна

## Преимущества новой структуры

✅ **Раннее тестирование**: Приложение можно запускать уже после этапа 3  
✅ **Постепенная интеграция**: Каждый модуль добавляется и тестируется отдельно  
✅ **Быстрая обратная связь**: Ошибки интеграции обнаруживаются сразу  
✅ **Итеративная разработка**: Можно проверять работоспособность на каждом шаге  
✅ **Упрощенная отладка**: Проблемы локализуются на этапе их возникновения  

## Временные оценки

- **Этапы 1-3**: 2-3 часа (настройка и базовое приложение)
- **Этапы 4-6**: 3-4 часа (утилиты и StorageModule)
- **Этапы 7-10**: 4-5 часов (DTO, FilesService, FilesController, FilesModule)
- **Этапы 11-12**: 2-3 часа (CleanupModule и интеграция)
- **Этап 13**: 1-2 часа (аутентификация)
- **Этапы 14-15**: 4-5 часов (тестирование)
- **Этапы 16-17**: 2-3 часа (Docker и документация)

**Общее время**: 18-25 часов разработки

## Примечания

- Каждый этап можно выполнять независимо после завершения предыдущих
- При возникновении ошибок возвращайтесь к предыдущим этапам
- Используйте AI для генерации кода, но всегда проверяйте результат
- Документируйте все изменения в CHANGELOG.md
- Следуйте принципам чистого кода и лучшим практикам NestJS
