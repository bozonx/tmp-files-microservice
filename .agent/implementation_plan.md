# План исправления обработки разрыва соединения клиентом

## Цель
Обеспечить корректную обработку разрыва соединения клиентом во всех критических операциях для предотвращения утечек памяти, зависаний и бесполезной траты ресурсов.

## Проблемы

### 1. Загрузка файлов (POST /files)
- Нет проверки разрыва соединения при чтении multipart данных
- Риск: утечка памяти, зависание операций

### 2. Загрузка по URL (POST /files/url)
- Загрузка с удаленного сервера продолжается даже после отмены клиентом
- Риск: бесполезная трата ресурсов (память, сеть, CPU)

### 3. Скачивание файлов (GET /download/:id)
- Весь файл загружается в память
- Нет обработки разрыва при отправке
- Риск: утечка памяти для больших файлов

## Решения

### Этап 1: Добавить утилиту для проверки разрыва соединения
**Файл:** `src/common/utils/request.util.ts`
- Создать функцию `isRequestAborted(request: FastifyRequest): boolean`
- Создать функцию `onRequestAborted(request: FastifyRequest, callback: () => void): void`

### Этап 2: Исправить загрузку файлов
**Файл:** `src/modules/files/files.controller.ts`
- Добавить проверку разрыва соединения перед началом обработки
- Добавить проверку после чтения каждой части multipart
- Очищать буферы при разрыве соединения
- Логировать события разрыва

### Этап 3: Исправить загрузку по URL
**Файл:** `src/modules/files/files.service.ts`
- Добавить параметр `request: FastifyRequest` в `uploadFileFromUrl`
- Передать request в `fetchRemoteFile`
- Прерывать загрузку с удаленного сервера при разрыве клиентского соединения
- Очищать ресурсы при прерывании

### Этап 4: Исправить скачивание файлов (streaming)
**Файл:** `src/modules/files/download.controller.ts`
**Файл:** `src/modules/files/files.service.ts`
- Изменить `downloadFile` для возврата stream вместо buffer
- Использовать `createReadStream` вместо `readFile`
- Обрабатывать события `error` и `close` на stream
- Логировать разрывы соединения

### Этап 5: Добавить тесты
**Файл:** `test/e2e/client-disconnect.e2e-spec.ts`
- Тест разрыва при загрузке файла
- Тест разрыва при загрузке по URL
- Тест разрыва при скачивании файла

## Метрики успеха
- ✅ Нет утечек памяти при разрыве соединения
- ✅ Операции прерываются немедленно при разрыве
- ✅ Все ресурсы корректно освобождаются
- ✅ События разрыва логируются
- ✅ Все тесты проходят
