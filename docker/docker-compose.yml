services:
  micro-stt:
    image: bozonx/stt-gateway-microservice:latest
    container_name: stt-gateway-microservice
    ports:
      - '8080:80'
    environment:
      # Basic app settings
      - NODE_ENV=production
      - LISTEN_HOST=0.0.0.0
      - LISTEN_PORT=80
      - TZ=UTC

      # API prefix
      - API_BASE_PATH=api
      - API_VERSION=v1

      # Logging
      - LOG_LEVEL=warn

      # Authorization
      - AUTH_ENABLED=true
      - AUTH_TOKENS=${AUTH_TOKENS}

      # STT settings
      - STT_DEFAULT_PROVIDER=assemblyai
      - STT_ALLOWED_PROVIDERS=assemblyai
      - STT_MAX_FILE_SIZE_MB=100
      - STT_REQUEST_TIMEOUT_SEC=15
      - STT_POLL_INTERVAL_MS=1500
      - STT_MAX_SYNC_WAIT_MIN=3
      - ALLOW_CUSTOM_API_KEY=false
      - ASSEMBLYAI_API_KEY=${ASSEMBLYAI_API_KEY}
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:80/api/v1/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
